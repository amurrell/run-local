#!/usr/bin/env bash

## Use to extend the usage of the rl commmand

# Load any rl-* functions in the rl-funcs folder
if [ -d "$REPO_ROOT/$RL_FUNC_FOLDER" ]; then
  for file in "$REPO_ROOT/$RL_FUNC_FOLDER/rl-"*; do
    if [ -f "$file" ]; then
      # shellcheck source=/dev/null
      source "$file"
      # echo "=== Loaded rl-extended function: $file"
    fi
  done
fi

show_help_extended() {
  color_text faint "RL-Extended (Custom) Commands: "
  echo ""
  pretty_option "$(color_text primary "e1)")"  "help-extended     " "· Show this help message"
  pretty_option "$(color_text primary "e2)")"  "list              " "· List all available rl sites in RL_DEV_FOLDER"
  pretty_option "$(color_text primary "e3)")"  "post-install      " "· Run post-install commands"
  pretty_option "$(color_text primary "e4)")"  "artisan           " "· Run an Artisan command"
  pretty_option "$(color_text primary "e5)")"  "debug-artisan     " "· Run an Artisan command with Xdebug enabled"
  pretty_option "$(color_text primary "e6)")"  "tinker            " "· Run the Tinker REPL"
  pretty_option "$(color_text primary "e7)")"  "debug-tinker      " "· Run the Tinker REPL with Xdebug enabled"
}

handle_rl_extended_choice() {
  case $1 in
    e1) ./run-local help-extended ;;
    e2) ./run-local list ;;
    e3) ./run-local post-install ;;
    e4) ./run-local artisan ;;
    e5) ./run-local debug-artisan ;;
    e6) ./run-local tinker ;;
    e7) ./run-local debug-tinker ;;
    *)
      step_text " No (valid) $1 option chosen... Quitting."
      exit 0
  esac
}

handle_rl_extended() {
  # Determine the script to run based on the first argument
  case $1 in
    help-extended)
      show_help_extended
      exit 0
      ;;
    list)
      # check alias is installed (using alias) requirement for rl list
      if ! alias rl &> /dev/null; then
        echo "Alias 'rl' is not installed. Please run 'rl install' to install it."
        exit 1
      fi
      # if we go 1 layer out, it will force rl alias
      (cd ../  && rl)
      exit $?
      ;;
    post-install)
      # Example of post-install, to put custom things like composer, artisan migrate, etc
      step_text "Running rl-extended post-install command"

      # Laravel specific
      step_text "Running Laravel specific post-install commands"
      laravel_post_install

      # Run npm
      step_text "Running npm install and $DEFAULT_NPM_COMMAND"
      run_npm_command "install && $DEFAULT_NPM_COMMAND"

      step_text " ✅ Installation complete! The environment is ready to use."
      printf "=== Visit the site at \e[32mhttp://localhost:%s\e[0m\n\n" "$PORT"
      exit 0
      ;;
    artisan)
      prompt_artisan_command "$@"
      # need everything after the first argument (eg. route:list)
      run_artisan_command "${*:2}"
      exit 0
      ;;
    debug-artisan)
      prompt_artisan_command "$@"
      run_debug_artisan_command "${*:2}"
      exit 0
      ;;
    tinker)
      run_tinker_command
      exit 0
      ;;
    debug-tinker)
      run_debug_tinker_command
      exit 0
      ;;
    *)
      echo "Unknown command: $1"
      exit 1
      ;;
  esac
}
